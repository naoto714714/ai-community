# 開発ガイドライン

このドキュメントには、このコードベースでの作業に関する重要な情報が含まれています。これらのガイドラインに正確に従ってください。

## コア開発ルール

1. パッケージ管理
   - uvのみを使用、pipは絶対に使わない
   - インストール: `uv add package`
   - ツールの実行: `uv run tool`
   - アップグレード: `uv add --dev package --upgrade-package package`
   - 禁止事項: `uv pip install`、`@latest`構文

2. データベース
   - **本番・開発環境**: Supabase PostgreSQL使用
   - **開発時**: 環境変数でDB接続情報設定
   - **セッション管理**: SQLAlchemy + PostgreSQL対応
   - **セキュリティ**: 
     - 環境変数による機密情報管理（パスワード等はログ出力禁止）
     - SSL接続の強制（sslmode=require）
     - 接続エラー時の適切なフォールバック処理
   - **エラーハンドリング**: 
     - データベース接続失敗時のログ記録
     - URLエンコーディング例外の処理

3. コード品質
   - すべてのコードに型ヒントが必要
   - パブリックAPIにはdocstringが必須
   - 関数は焦点を絞って小さくする
   - 既存のパターンに正確に従う
   - 行の長さ: 最大120文字
   - **定数管理**: マジックナンバーや固定文字列は`src/backend/constants/`モジュールで管理
     - AI設定: `constants/ai_config.py`
     - ログ設定: `constants/logging.py`
     - タイムゾーン: `constants/timezone.py`

5. AI機能開発
   - **プロンプト管理**: `prompts/people/`ディレクトリでAI人格を管理
   - **人格設定**: 各AI人格は独立したMarkdownファイルで定義
   - **連続発言防止**: 同じAI人格による連続発言を防ぐロジックの実装
   - **設定可能な設定**: 環境変数による動的設定対応
     - `AI_MAX_OUTPUT_TOKENS`: AI応答の最大トークン数（デフォルト: 2048）
     - `AI_CONVERSATION_ENABLED`: 自律会話機能の有効/無効
     - `AI_CONVERSATION_INTERVAL_SECONDS`: 自動会話の間隔（秒単位）
   - **エラーハンドリング**: 
     - Gemini API障害時のフォールバック処理
     - 人格選択失敗時のデフォルト人格設定
     - AI応答生成タイムアウト処理
   - **ログ記録**: 
     - AI応答生成時間の記録
     - 人格選択ロジックのデバッグログ
     - API呼び出し状況の監視

4. テスト要件
   - フレームワーク: `uv run --frozen pytest`
   - 非同期テスト: asyncioではなくanyioを使用
   - カバレッジ: エッジケースとエラーをテスト
   - 新機能にはテストが必要
   - バグ修正にはリグレッションテストが必要
   - **AI機能テスト**: 
     - Gemini APIはモック使用（外部依存を避ける）
     - 人格選択ロジックのユニットテスト
     - 自律会話タイマー機能のテスト
     - 連続発言防止機能のテスト
     - WebSocket経由でのAI応答ブロードキャストテスト

## プルリクエスト

- 何が変更されたかの詳細なメッセージを作成する。解決しようとしている問題の高レベルな説明と、それがどのように解決されるかに焦点を当てる。明確さを加える場合を除き、コードの詳細には立ち入らない。

## コードフォーマット

1. Ruff
   - フォーマット: `uv run --frozen ruff format .`
   - チェック: `uv run --frozen ruff check .`
   - 修正: `uv run --frozen ruff check . --fix`
   - 重要な問題:
     - 行の長さ (120文字)
     - インポートの並び替え (I001)
     - 未使用のインポート
   - 行の折り返し:
     - 文字列: 括弧を使用
     - 関数呼び出し: 適切なインデントで複数行
     - インポート: 複数行に分割

2. 型チェック
   - ツール: `uv run --frozen pyright`
   - 要件:
     - Optionalに対する明示的なNoneチェック
     - 文字列の型の絞り込み
     - チェックが通ればバージョン警告は無視可能

3. Pre-commit
   - 設定: `.pre-commit-config.yaml`
   - 実行タイミング: git commit時
   - ツール: Prettier (YAML/JSON)、Ruff (Python)
   - Ruffの更新:
     - PyPiバージョンをチェック
     - config revを更新
     - まず設定をコミット

## エラー解決

1. CI失敗
   - 修正順序:
     1. フォーマット
     2. 型エラー
     3. リンティング
   - 型エラー:
     - 完全な行のコンテキストを取得
     - Optional型をチェック
     - 型の絞り込みを追加
     - 関数シグネチャを検証

2. 一般的な問題
   - 行の長さ:
     - 括弧で文字列を分割
     - 複数行の関数呼び出し
     - インポートを分割
   - 型:
     - Noneチェックを追加
     - 文字列型を絞り込む
     - 既存のパターンに合わせる
   - Pytest:
     - テストがanyio pytestマークを見つけられない場合、pytestの実行コマンドの先頭に PYTEST_DISABLE_PLUGIN_AUTOLOAD="" を追加してみる
       例: `PYTEST_DISABLE_PLUGIN_AUTOLOAD="" uv run --frozen pytest`
   - AI機能:
     - **メッセージ途切れ問題**: `AI_MAX_OUTPUT_TOKENS`を適切に設定（推奨: 2048）
     - **連続発言エラー**: `exclude_user_id`パラメータの正しい伝播を確認
     - **人格選択失敗**: フォールバック人格の設定と例外処理の実装
     - **自律会話停止**: タイマー設定と環境変数の確認
     - **Gemini API エラー**: リトライ機能とタイムアウト設定の調整

3. ベストプラクティス
   - コミット前にgit statusをチェック
   - 型チェック前にフォーマッターを実行
   - 変更は最小限に保つ
   - 既存のパターンに従う
   - パブリックAPIを文書化
   - 徹底的にテスト
