# AI Community フロントエンド仕様

このドキュメントでは、AI Communityプロジェクトのフロントエンドアプリケーションに関する技術仕様を定義します。

プロジェクト全体の概要、アーキテクチャ、起動方法については、ルートディレクトリにある [`CLAUDE.md`](../CLAUDE.md) を参照してください。

## 1. プロジェクト構造

プロジェクト全体の主要なファイルとディレクトリの役割は以下の通りです。

```text
ai-community/
├── docs/                      # ドキュメント関連ファイル
│   ├── backend.md            # バックエンドの技術仕様書
│   └── frontend.md           # フロントエンドの技術仕様書（このファイル自身）
├── src/
│   ├── backend/              # バックエンドアプリケーション (FastAPI)
│   └── frontend/             # フロントエンドアプリケーション (React)
│       ├── src/
│       │   ├── App.tsx              # アプリケーションのメインエントリーポイント
│       │   ├── main.tsx             # Reactアプリケーションのレンダリング開始点
│       │   ├── components/          # 再利用可能なReactコンポーネント群
│       │   │   ├── Layout.tsx       # アプリケーション全体のレイアウトと状態管理
│       │   │   ├── ChannelList.tsx  # チャンネル一覧表示コンポーネント
│       │   │   ├── ChatArea.tsx     # チャット表示エリアと入力エリアを統合したコンポーネント
│       │   │   ├── MessageList.tsx  # メッセージリスト表示コンポーネント
│       │   │   ├── MessageItem.tsx  # 個々のメッセージ表示コンポーネント
│       │   │   └── MessageInput.tsx # メッセージ入力フォームコンポーネント
│       │   ├── types/               # TypeScriptの型定義ファイル
│       │   │   └── chat.ts          # チャット機能に関連する型定義
│       │   ├── config/              # アプリケーション設定ファイル
│       │   │   └── constants.ts     # APIエンドポイントなどの定数定義
│       │   └── data/                # 静的な初期データファイル
│       │       └── channels.ts      # チャンネルの初期リストデータ
│       ├── package.json         # フロントエンドの依存関係とスクリプト定義
│       └── vite.config.ts       # Viteビルドツールの設定ファイル
├── tests/                     # テストコードディレクトリ
│   ├── backend/              # バックエンドのテストコード
│   └── frontend/             # フロントエンドのテストコード
├── CLAUDE.md                  # 開発ガイドラインとプロジェクト全体の説明
└── package.json               # プロジェクトルートのnpmスクリプトと依存関係
```

## 2. 技術スタック

フロントエンドは以下の技術スタックで構築されています。使用されているライブラリの完全なリストは、[`src/frontend/package.json`](../src/frontend/package.json) を参照してください。

- **フレームワーク**: React 19
- **言語**: TypeScript 5
- **UIライブラリ**: Mantine 8
- **ビルドツール**: Vite
- **テスト**: Vitest, Testing Library
- **コード品質**: ESLint, Prettier

## 3. コンポーネント仕様

### `Layout.tsx`
アプリケーション全体のレイアウトを管理し、主要なロジックを統括するコンポーネントです。

- **役割**:
  - WebSocket接続の確立と管理（再接続処理を含む）
  - チャンネル選択状態の管理
  - メッセージ履歴の取得とリアルタイム更新
  - メッセージ送信処理のハンドリング
- **状態管理**:
  - `activeChannelId`: 現在選択中のチャンネルID
  - `messages`: 表示中のメッセージ配列
  - `wsRef`: WebSocketインスタンスへの参照

### `MessageInput.tsx`
メッセージの入力と送信を担当するフォームコンポーネントです。

- **機能**:
  - テキスト入力（最大2000文字）
  - `Ctrl+Enter` または `⌘+Enter` によるメッセージ送信
  - 日本語入力中のEnterキーによる誤送信防止（Composition Eventsを利用）
  - 送信ボタンの活性/非活性制御

### `MessageItem.tsx`
個々のメッセージを表示するためのコンポーネントです。

- **機能**:
  - メッセージ内容とタイムスタンプ (`HH:mm`) の表示
  - 送信者（自分、他人、AI）に応じたスタイル変更
    - **自分**: `blue`
    - **AI**: `violet`
    - **他人**: `gray`
  - AIが送信したメッセージには `AI` バッジを表示

## 4. データフローとバックエンド連携

### 4.1. REST API
アプリケーションの初期化時に、チャンネルごとのメッセージ履歴を取得するために使用されます。

| エンドポイント                        | メソッド | 説明               |
| ------------------------------------- | -------- | ------------------ |
| `/api/channels/{channel_id}/messages` | GET      | メッセージ履歴の取得 |

### 4.2. WebSocket通信
リアルタイムなメッセージの送受信は、WebSocket (`ws://localhost:8000/ws`) を通じて行われます。

**メッセージ送信フロー:**
1.  **楽観的更新 (Optimistic Update)**:
    - ユーザーがメッセージを送信すると、`Layout.tsx` がまずローカルの `messages` 状態を更新し、UIに即座に反映させます。
2.  **サーバーへの送信**:
    - WebSocketを通じて、バックエンドに `{ "type": "message:send", "data": { ... } }` 形式でメッセージを送信します。
3.  **サーバーからの応答**:
    - **成功時**: バックエンドはメッセージをデータベースに保存し、全てのクライアントに `{ "type": "message:broadcast", "data": { ... } }` を送信します。フロントエンドはこれを受信しますが、重複を避けるため、既に楽観的更新で追加済みの場合は何も処理しません。
    - **失敗時**: バックエンドから `{ "type": "message:error", "data": { ... } }` が返された場合、楽観的更新で追加したメッセージをローカルの状態から削除（ロールバック）します。

**AI応答フロー:**
1.  ユーザーが `@AI` を含むメッセージを送信します。
2.  上記の送信フローと同様に、メッセージはバックエンドに送信されます。
3.  バックエンドはAIに応答を生成させ、`message:broadcast` を通じてAIのメッセージを全てのクライアントに配信します。
4.  フロントエンドはAIのメッセージを通常のメッセージと同様に受信し、`userType: 'ai'` に基づいて専用のスタイルで表示します。

**AI自律会話:**
- 「雑談」チャンネルでは、バックエンドのタイマー機能により、AIが自動的に発言します。
- この発言も `message:broadcast` を通じて配信され、フロントエンドは他のメッセージと区別なくリアルタイムで表示します。

## 5. 開発コマンド

フロントエンド開発に関連する主要なnpmスクリプトです。

- `npm run dev`: 開発サーバーを起動します。
- `npm run build`: プロダクション用にビルドします。
- `npm run lint`: ESLintでコードを静的解析します。
- `npm run format`: Prettierでコードをフォーマットします。
- `npm run test`: Vitestでユニットテストを実行します。

その他のスクリプトについては `package.json` を参照してください。
